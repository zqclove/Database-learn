# 第六章：查询性能优化

​	查询的优化不仅仅是语句上需要优化，还需要在索引、库表结构上进行优化。三者对性能优化都是不可或缺的。

# 查询慢的原因

​	查询性能与响应时间息息相关。如果我们将查询看作是一个任务，那么它是由一系列子任务组成，每个子任务都会消耗一定的时间。如果要优化查询，其实是优化它的子任务，要么减少子任务的执行次数，要么消除子任务，要么让子任务运行的更快。

—— —————————**对于如何剖析查询任务，这里有个连接待写，mark一下**。————————————

​	要了解查询慢的原因，可以从查询的生命周期的各个阶段入手，每个阶段可能会有不同的优化手段。

​	执行一个查询时，大多数情况都会产生一些不必要的额外操作、某些操作被额外地重复多次、某些操作执行得太慢等。优化查询的目的就是减少和消除这些操作所花费的时间。

​	由此看来，了解查询的生命周期和清除查询的时间消耗情况对于优化查询有很大的意义。

# 慢查询基础：优化数据访问

​	查询性能低下最基本的原因是**访问数据太多**。对于大部分性能低下的查询可以通过减少访问的数据量进行优化。对于低效的查询，可以通过以下两个步骤分析：

- 确认应用程序是否检索大量超过需要的数据，可能是访问了太多的行或列（应用程序角度）；
- 确认MySQL服务器层是否在分析大量超过需要的数据行（MySQL服务器角度）；

## 避免请求不需要的数据

​	从应用程序角度出发，对于一些查询会请求超过实际需要的数据，而应用程序不需要这些多余的数据，会将之丢弃。这不仅给MySQL服务器带来额外的负担，还会消耗应用程序服务器的CPU和内存资源，甚至在分布式环境下会增加网络开销。

​	以下是应用程序请求不需要的数据的典例：

### 查询不需要的记录

​	开发者在设计应用程序对数据库查询请求代码时，习惯先使用 `select` 语句查询大量的结果，然后再从结果集中获取其中的n行数据（例如某网站从数据取出1000条记录，但真正在页面显示的只有前面10条记录）。这是误认为 MySQL服务器会返回应用程序需要的数据。这种原因的产生一般是发生在应用程序代码层面，是开发者在设计代码时应注意的问题。**最简单有效的解决方法就是在查询后面加上 `limit`**。

### 多表关联时返回全部列

​	如果需要多表关联获取所需的结果，需要在编写查询语句时注意不要按如下写法编写：

```sql
select * from db.table1
inner join db.table2 using(index2)
inner join db.table3 using(index3)
where db.table2.col1 = 'xxxx';
```

​	这会返回table1、table2、table3 三个表的全部数据列。正确的方式应该如下只取需要的列：

```sql
select db.table1.* from ....;
```

​	即 ***** 的使用方式，应该指定所需数据所在的数据表。

### 总是取出全部列



​	