# MySQL日志系统

## Redo log

​	**redo log** 是 InnoDB 实现的物理日志，记录的是数据在磁盘页面的物理变化，即“对数据做了什么”。它主要用于数据库崩溃恢复（**crash-safe**）。后面会讲到为什么 **redo log** 具有 **crash-safe** 能力。

### 基本组成

​	redo log基本由两部分组成 ： 

- 在内存中的 **redo log buffer**，是易失的。

    ​	在内存中 redo log buffer 是采用**循环写**的方式：**write pos** 是记录当前位置，**checkpoint** 是当前要擦除的位置。

- 在磁盘中的 **redo log file**，是持久的。

    ​	redo log file主要是将 redo log buffer 中的记录到磁盘中，按顺序写的方式实现落盘。

### 基本流程

​	当一个事务在执行过程中需要修改数据时，MySQL会做出以下步骤：

1. 检查内存中是否有该数据，如果有则可以直接修改，无需访问磁盘，执行步骤3；否则执行步骤2；
2. 从磁盘中读取数据到内存中，以备修改；
3. 修改内存中数据拷贝，并将修改记录写到内存中的 redo log buffer 中；
4. 当事务commit时，根据 **WAL** 技术，先将 redo log buffer 中的内容刷新到 redo log file 中，对redo log file 采用追加写的方式。
5. 定期将内存中修改的数据刷新到磁盘中。

### WAL(Write-Ahead Log)

​	上述提到的 **WAL** 技术被成为**预先日志持久化**，在持久化一个数据页之前，先将内存中的日志页持久化。

该目的是为了保证 crash-safe能力。

​	假设在没有使用 **WAL** 的场景下（即不使用redo log）：事务修改数据需要从磁盘中获取数据，并在内存中修改，事务提交后并不是立即将内存中的数据页面写到磁盘中，而是定期将内存中的数据刷新到磁盘中。这种情况就无法保证事务的持久性，因为如果在数据页面写到磁盘前，MySQL服务器崩溃，那么内存中的数据就会丢失，就会发生事务明明提交成功，数据库中却没有该数据的情况。

​	这就是为什么大多数存储系统基本都会用到 **WAL** 技术的主要原因，在提交事务后先将日志记录到磁盘中，保证了事务一致性和持久性，并且提高了语句执行性能。

### redo log如何确保事务持久性

​	为了保证 redo log buffer 的内容都写入 redo log file 中，默认情况下， InnoDB存储引擎都需要调用一次 **fsync** 操作。**fsync操作会将数据以同步阻塞的方式写入磁盘**

​	因为 redo log 并没有打开 **O_DIRECT选项**，所以重做日志**先写入到文件系统缓存，并没有直接写入磁盘中**。为了确保重做日志写入到磁盘，必须进行一次 **fsync操作**。**fsync是一种系统调用操作**，其fsync的效率取决于磁盘的性能，因此磁盘的性能也影响了事务提交的性能，也就是数据库的性能。
​	 **(O_DIRECT选项是在Linux系统中的选项，使用该选项后，对文件进行直接IO操作，不经过文件系统缓存，直接写入磁盘)**

### innodb_flush_log_at_trx_commit 参数

​	该参数可以控制 **严格遵循 ACID 提交操作 **和 **更高性能的磁盘 I/0 操作** 之间的平衡。你可以通过修改默认值（默认值为1）以获取更高的性能，同时你可能会在 crash 中失去事务。简单来说， 该参数就是控制 redo log 刷新到磁盘的策略，设置该参数值可以使用户用持久性换取更高性能的 I/O。

- 为了完全符合ACID，默认设置为 **1** 是必需的。在每个事务提交时，确保日志被写入并刷新到磁盘，必须调用一次 fsync 操作，保证持久性。

- 参数设置为 **0** ，那么日志会以**每秒一次**的方式写入并刷新到磁盘中，所以发生 crash 最多丢失一秒内的事务。这种方式事务提交时不进行写入redo log 操作，这个操作仅在 **master thread** 完成，在 **master thread** 中每秒进行一次写入redo log 并执行 fsync 操作。

- 参数设置为 **2**，则会在事务提交时写入日志，并每秒一次刷新到磁盘中。该参数下，只保证将 redo log buffer  写到系统的页面缓存中，不进行 fsync 操作，只做 **write** 操作（将内存数据写到页面缓存中，依靠系统调度机制将缓存数据刷新到磁盘中）。因此如果 MySQL服务器宕机时，不会丢失事务，但操作系统宕机则可能丢失最多一秒的事务。

      

​	关于参数 **0** 和 **2** 中的每秒刷新是并不能百分百保证在一秒内做到一次刷新的。刷新可能会受到DDL的变化、其他InnoDB内部活动的影响而使频率上下浮动。因为 **DDL的变化和其他InnoDB内部活动引起刷新是独立于 innodb_flush_log_at_trx_commit 参数的。**

​	同样，也可以通过 **innodb_flush_log_at_timeout** 设置刷新频率，设置为 N 则表示每 N 秒刷新一次。减少刷新次数可以避免影响 **binlog 组提交**的性能。



## Bin log



## Undo log





# 参考资料

[丁奇MySQL实战45讲](https://time.geekbang.org/column/article/68633)

[浅析MySQL事务中的redo与undo](https://www.jianshu.com/p/20e10ed721d0 )