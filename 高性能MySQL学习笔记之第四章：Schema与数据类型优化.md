

# 第四章：Schema与数据类型优化

​	本章节学习内容：MySQL数据库的设计，主要介绍的是MySQL数据库设计与其他关系型数据库管理系统的区别。

​	本章内容是为第五章和第六章做铺垫。这三章讨论逻辑设计、物理设计和查询执行，以及它们之间的相互作用。

## 选择优化的数据类型

​	选择正确的数据类型对于获得高性能至关重要。不管存储哪种类型的数据，下面几个简单的原则都有助于做出更好的选择：

- **更小的通常更好**：

    ​	一般情况下，**应该尽量使用可以正确存储数据的最小数据类型**。更小的数据类型占用**更少的磁盘、内存和CPU缓存**，并且处理时需要的**CPU周期也更少**，因此它们会更快。

- **简单就好**：

    ​	简单数据类型的操作通常需要**更少的CPU周期**。例如，整型比字符操作代价更低，因为字符集和校对规则（排序规则）使字符的比较 比 整型比较更复杂。因为字符操作的代价高昂，所以应该使用MySQL内建类型存储日期和时间，使用整型存储IP地址。

- **尽量避免NULL**：

    ​	如果查询中包含可为 NULL 的列，对 MySQL 来说更难优化，因为**可为 NULL 的列使得索引、索引统计和值比较都更复杂**，并且会**使用更多的存储空间**，在MySQL里也需要特殊处理。

    ​	当可为 NULL 的列被索引时，每个索引记录需要一个额外的字节，在 MyISAM 里甚至还可能导致固定大小的索引（例如只有一个整数列的索引）变成可变大小的索引。



​	在为列选择合适的数据类型时，第一步需要**确定合适的大类型**：数组、字符串、时间等。第二步是**选择具体类型**，MySQL的数据类型可以存储相同类型的数据，只是存储的长度和范围不一样、允许的精度不同，或者需要的物理空间不同，也会有一些不同的行为和属性。

​	**个人总结**：在设计字段时，应该以“更轻、更快、更简单”为目标确定数据类型。从资源使用角度上看，占用越少资源的数据类型越好；从操作代价角度上看，代价越少的数据类型越好。总的来说，一切都是为了更简单、更快捷。

### 整数类型

​	整数类型根据存储范围和大小，又分为五种：

| Type        | Storage (Bytes) | Minimum Value Signed | Minimum Value Unsigned | Maximum Value Signed | Maximum Value Unsigned |
| ----------- | --------------- | -------------------- | ---------------------- | -------------------- | ---------------------- |
| `TINYINT`   | 1               | `-128`               | `0`                    | `127`                | `255`                  |
| `SMALLINT`  | 2               | `-32768`             | `0`                    | `32767`              | `65535`                |
| `MEDIUMINT` | 3               | `-8388608`           | `0`                    | `8388607`            | `16777215`             |
| `INT`       | 4               | `-2147483648`        | `0`                    | `2147483647`         | `4294967295`           |
| `BIGINT`    | 8               | `-2^63`              | `0`                    | `2^63-1`             | `2^64-1`               |

​	整型类型有可选的 `unsigned`属性，表示不允许负值，使用该属性的范围也会发生变化，大概可以使整数的上上限提高一倍。

​	有符号和无符号类型使用相同的存储空间，具有相同的性能，因此可以根据实际情况选择合适的类型。

​	**整数计算**一般使用 64位 的 `BIGINT`整数，即使在 32位 环境也是如此。（一些聚合函数是例外，它们使用 `DECIMAL` 或 `DOUBLE` 进行计算）。

​	MySQL可以为整数类型指定宽度，但它对存储空间无关，只是规定了MySQL的一些交互工具用来显示字符的个数。

### 实数类型

​	实数是**带有小数部分**的数字。但它们不只是为了存储小数部分，也可以使用`DECIMAL`存储比`BIGINT`还大的整数。在MySQL即支持精确类型，也支持不精确类型。

​	`DECIMAL`和`NUMERIC`类型存储实数值，在MySQL中，`NUMERIC`被实现为`DECIMAL`，所以后面的`DECIMAL`介绍同样适用于`NUMERIC`。（`NUMERIC`相当于`DECIMAL`的别名，同 `INT`与`INTEGER`）

​	`DECIMAL`类型用于**存储精确的小数**。在MySQL中，`DECIMAL`的值**存储在二进制字符串**（4个字节存9个数字，小数点占1个字节）中。

​	`DECIMAL`声明例子如下：

```sql
DECIMAL(5,2)
```

​	其中5表示精度，2表示小数点后的位数，所以该声明的值的存储范围是 -999.99 到 999.99 。

​	如果小数位为0，则十进制值不包含小数点或小数部分。

​	`DECAMAL`类型最多存储65位数字，但是给定的`DECIMAL`列的实际范围可以受到给定列的精度或小数位的限制。

​	因为CPU不支持对`DECIMAL`的直接计算，所以MySQL服务器自身实现了`DECIMAL`的高精度计算。相对而言，CPU直接支持原生浮点计算，所以浮点运算明显更快（`FLOAT`和`DOUBLE`类型支持使用标准的浮点运算进行近似计算）。

​	因为需要额外的空间和计算开销，所以应该尽量只在对小数进行精确计算时才使用`DECIMAL`，例如财务数据相关。但在数据量比较大的时候，可以考虑使用`BIGINT`代替`DECIMAL`，将需要存储的货币单位根据小数点的位数乘以相应的倍数即可。例如要存储财务数据精确到0.00001，则可以把所有金额乘以10^5，然后将结果存储在`BIGINT`里，这样可以同时避免浮点存储计算不精确和`DECIMAL`精确计算代价高的问题。

### 字符串类型

​	MySQL支持多种字符串类型，每种类型还有很多变种。从MySQL 4.1开始，每个字符串可以定义自己的字符集和排序规则（校对规则）。

#### CHAR和VARCHAR

​	`CHAR`和`VARCHAR`是两种最主要的字符串类型。它们的值是如何存储在磁盘和内存中，是与存储引擎的具体实现有关。



# 参考资料

《高性能MySQL》（第三版）——Baron Scbwartz等著